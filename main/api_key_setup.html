<!DOCTYPE html>
<html>
<head>
  <title>Custom Modal Template</title>
  <base target="_blank">
  <?!= include('main/styles'); ?>
</head>
<body>
  <div class="content" id="modalContent">
    <p><?= message ?></p>
  </div>
  <div class="environment-selection">
    <label for="environment">Select Environment:</label>
    <select id="environment">
      <option value="demo">Demo</option>
      <option value="live">Live</option>
    </select>
  </div>
  <div class="api-key-input">
    <label for="apiKey">Enter API Key:</label>
    <input type="text" id="apiKey" placeholder="API Key" oninput="toggleSaveButton()">
  </div>
  <button id="saveButton" onclick="saveApiKey()" disabled>Save</button>
  <div id="statusMessage" style="color: red;"></div>

  <script>
    /**
     * Saves the API key along with the selected environment.
     * Validates the API key input before proceeding.
     */
    function saveApiKey() {
      const apiKey = document.getElementById('apiKey').value;
      const environment = document.getElementById('environment').value;
      if (apiKey) {
        google.script.run.withSuccessHandler(onSaveSuccess).withFailureHandler(onSaveFailure).saveApiKey(apiKey, environment);
      } else {
        document.getElementById('statusMessage').innerText = 'Please enter a valid API key.';
      }
    }

    /**
     * Handles the success response after saving the API key.
     * Displays a success message and closes the modal after a short delay.
     */
    function onSaveSuccess() {
      document.getElementById('statusMessage').innerText = 'API Key saved successfully!';
      setTimeout(() => google.script.host.close(), 1000);
    }

    /**
     * Handles the failure response when saving the API key.
     * Displays an error message with the provided error details.
     *
     * @param {Object} error - The error object containing details of the failure.
     */
    function onSaveFailure(error) {
      document.getElementById('statusMessage').innerText = 'Failed to save API Key: ' + error.message;
    }

    /**
     * Toggles the state of the Save button based on the API key input field.
     * Enables the button only if a valid API key is entered.
     */
    function toggleSaveButton() {
      const apiKey = document.getElementById('apiKey').value;
      const saveButton = document.getElementById('saveButton');
      saveButton.disabled = !apiKey;
    }
  </script>
</body>
</html>